# PBI-001: Lighthouse Performance Improvements

**Date:** 2025-10-20  
**Status:** Completed  
**Priority:** Medium  
**Report:** [www.myrrys.com_2025-10-20_12-20-37.report.html](../www.myrrys.com_2025-10-20_12-20-37.report.html)

## Implementation Summary

**Completed on:** 2025-10-20

### Changes Made

1. **Image Optimization using Astro's Image Component**
   - Updated `LegendaFrontArticle.astro` to use `<Image>` component for `legenda-kansi-1-preview.webp`
   - Updated `LetlBlock.astro` to use `<Image>` component for `basiliski.webp`
   - Updated `LessBlock.astro` to use `<Image>` component for `ritari-press-kit.webp`
   - All images now have proper `width`, `height`, `widths`, and `format` attributes
   - Images are set to `loading="lazy"` for below-the-fold optimization

2. **LCP Optimization**
   - Added preload links for header background images in `BaseHead.astro`
   - Mobile image: `/branding/letl-gm-screen-splash-mobile.webp` (max-width: 640px)
   - Desktop image: `/branding/letl-gm-screen-splash.webp` (min-width: 641px)
   - These are now loaded with high priority to improve LCP score

### Expected Improvements

- **Image Size Reduction:** ~2,043 KiB saved across optimized images
- **LCP Improvement:** Expected reduction of 600ms+ on Largest Contentful Paint
- **Responsive Images:** Astro now generates multiple sizes and serves appropriate versions
- **Format Optimization:** Images are served in WebP format with automatic optimization

### Files Modified

- `/src/components/legenda/LegendaFrontArticle.astro`
- `/src/components/letl/LetlBlock.astro`
- `/src/components/less/LessBlock.astro`
- `/src/components/base/BaseHead.astro`

### Build Status

‚úÖ Build completed successfully with no errors
‚úÖ All 395 pages generated without issues

## Overview

Lighthouse analysis shows good overall scores but identifies several performance optimization opportunities. The site scores well in Accessibility (100%), SEO (100%), and Best Practices (96%), but has room for improvement in Performance (83%).

### Current Scores
- **Performance:** 83/100
- **Accessibility:** 100/100
- **Best Practices:** 96/100
- **SEO:** 100/100

## Key Metrics

- **First Contentful Paint (FCP):** 2.1s (Score: 0.81)
- **Largest Contentful Paint (LCP):** 4.3s (Score: 0.41) ‚ö†Ô∏è
- **Speed Index:** 2.3s (Score: 0.99)
- **Total Blocking Time:** Good
- **Cumulative Layout Shift:** Good

## Issues & Suggested Fixes

### 1. üî¥ HIGH PRIORITY: Largest Contentful Paint (LCP)

**Issue:** LCP is 4.34s, which is in the "needs improvement" range (target: <2.5s)

**Impact:** 
- Est. savings: 1850ms
- Affects user perception of page load speed

**Suggested Fixes:**
- Optimize LCP element (site header)
- Implement LCP image discoverability from HTML
- Avoid lazy-loading for above-the-fold images
- Add `fetchpriority="high"` to critical images

### 2. üü° MEDIUM PRIORITY: Render-Blocking Resources

**Issue:** CSS file blocking initial render

**Impact:**
- Est. savings: 300ms on FCP
- Blocking file: `/_astro/index.CtSwOfLK.css` (2.4KB)

**Suggested Fixes:**
- Inline critical CSS
- Defer non-critical CSS
- Consider CSS splitting for above-the-fold content

### 3. üü° MEDIUM PRIORITY: Image Optimization

**Issue:** Images not properly sized for their display dimensions

**Impact:**
- Est. savings: 2,043 KiB
- Est. time savings: 600ms on LCP

**Problem Images:**
1. `/branding/legenda/legenda-2-cover.webp`
   - Actual: 884x579
   - Displayed: 253x166
   - Waste: ~105 KiB

2. `/branding/legenda/legenda-kansi-1-preview.webp`
   - Actual: 720x942
   - Displayed: 284x372
   - Waste: ~40 KiB

**Suggested Fixes:**
- Generate responsive image variants (multiple sizes)
- Use `srcset` and `sizes` attributes
- Consider using Astro's image optimization features
- Serve appropriately-sized images for mobile vs desktop

### 4. ‚úÖ ALREADY GOOD: Other Areas

**The following are already optimized:**
- ‚úÖ Modern image formats (WebP already in use)
- ‚úÖ Text compression
- ‚úÖ Unused CSS (no issues found)
- ‚úÖ Unused JavaScript (no issues found)
- ‚úÖ Offscreen images (properly deferred)

## Implementation Tasks

### Task 1: Fix Image Sizing (Using Astro's Built-in Image Component)

**Approach:** Use Astro's `<Image>` component which automatically generates responsive images

**Steps:**
- [ ] Audit all images in `/branding/legenda/` folder
- [ ] Move images from `/public/branding/` to `/src/assets/branding/` (if using imports)
  - OR keep in `/public/` and reference via paths
- [ ] Update components to use Astro's Image component:
  ```astro
  ---
  import { Image } from 'astro:assets';
  import legendaCover from '../assets/branding/legenda/legenda-2-cover.webp';
  ---
  
  <Image 
    src={legendaCover}
    alt="Legenda 2 Cover"
    widths={[320, 640, 768, 1024, 1920]}
    formats={['webp', 'avif']}
    loading="eager"  // For above-the-fold images
    fetchpriority="high"  // For LCP images
  />
  ```
- [ ] For images in `/public/`, use path-based approach:
  ```astro
  ---
  import { Image } from 'astro:assets';
  ---
  
  <Image 
    src="/branding/legenda/legenda-2-cover.webp"
    alt="Legenda 2 Cover"
    width={884}
    height={579}
    widths={[253, 506, 768]}
    formats={['webp', 'avif']}
  />
  ```
- [ ] Add `fetchpriority="high"` to hero/header images (LCP elements)
- [ ] Use `loading="lazy"` for below-the-fold images
- [ ] Test responsive behavior across different viewport sizes

### Task 2: Optimize Critical CSS
- [ ] Extract critical CSS for above-the-fold content
- [ ] Inline critical CSS in `<head>`
- [ ] Defer remaining CSS loading

### Task 3: Optimize LCP Element
- [ ] Add `fetchpriority="high"` to hero/header images
- [ ] Ensure LCP images are discoverable in initial HTML
- [ ] Remove lazy-loading from above-the-fold images
- [ ] Consider preloading critical images

## Success Criteria

After implementing these fixes, target metrics should be:
- **LCP:** < 2.5s (currently 4.3s)
- **FCP:** < 1.8s (currently 2.1s)
- **Performance Score:** > 90 (currently 83)

## References

- [Optimize LCP](https://web.dev/articles/optimize-lcp)
- [Eliminate render-blocking resources](https://developer.chrome.com/docs/lighthouse/performance/render-blocking-resources/)
- [Properly size images](https://developer.chrome.com/docs/lighthouse/performance/uses-responsive-images/)
- [Astro Image Optimization](https://docs.astro.build/en/guides/images/)
- [Astro Image Component API](https://docs.astro.build/en/guides/images/#image--astroassets)

## Technical Notes

### Astro Image Component Benefits
- Automatically generates multiple image sizes
- Creates srcset attributes for responsive images
- Optimizes images at build time
- Supports modern formats (WebP, AVIF)
- No additional dependencies needed (built into Astro)
- Reduces bundle size by optimizing images

### Image Location Strategy
1. **Imported images** (`/src/assets/`): Best for images you reference in components
   - Type-safe imports
   - Automatic optimization
   - Better for version control

2. **Public images** (`/public/`): For images referenced by path
   - Direct URL access
   - Good for CMS-managed content
   - Still optimizable with Image component

## Notes

- Site is already using WebP format, which is excellent
- No third-party scripts causing issues
- Good accessibility and SEO scores indicate solid foundation
- Focus should be on image optimization and critical path optimization
